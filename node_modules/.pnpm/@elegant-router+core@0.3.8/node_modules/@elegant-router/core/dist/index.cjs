"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const u=require("micromatch"),s$1=require("fast-glob"),i$1=require("node:process"),i=require("node:path"),consola=require("consola"),chokidar=require("chokidar"),kolorist=require("kolorist");function _interopDefaultCompat(o){return o&&typeof o=="object"&&"default"in o?o.default:o}const u__default=_interopDefaultCompat(u),s__default=_interopDefaultCompat(s$1),i__default$1=_interopDefaultCompat(i$1),i__default=_interopDefaultCompat(i);function getGlobs(o,t,e){const{sync:r}=s__default;return r(o,{onlyFiles:!0,cwd:e,ignore:t}).sort()}function getFullPathOfPageGlob(o,t,e){return i__default.posix.join(e,t,o)}function normalizeWindowsPath(o){return o.replace(/\\/g,"/")}function createPluginOptions(o){const t="src/views",e=["**/index.vue","**/[[]*[]].vue"],r=["**/components/**"],n={cwd:i__default$1.cwd(),pageDir:t,alias:{"@":"src"},pagePatterns:e,pageExcludePatterns:r,routeNameTransformer:a=>a,routePathTransformer:(a,l)=>l,log:!0,...o};return n.cwd=normalizeWindowsPath(n.cwd),n}const PATH_SPLITTER="/",PAGE_DEGREE_SPLITTER="_",PAGE_DIR_NAME_PATTERN=/^[\w-]+[0-9a-zA-Z]+$/,PAGE_FILE_NAME_PATTERN=/^[0-9a-zA-Z]+[0-9a-zA-Z-]+[0-9a-zA-Z]+\.[a-z]+$/,PAGE_FILE_NAME_WITH_SQUARE_BRACKETS_PATTERN=/^\[\w+\]\.[a-z]+$/,UPPERCASE_LETTER_PATTERN=/[A-Z]/g;function handleValidatePageGlob(o,t){const e=o.split(PATH_SPLITTER).reverse(),[r,...n]=e,a=[[e.length<2,`The glob "${t}" is invalid, it must has the parent directory.`],...n.map(l=>[!PAGE_DIR_NAME_PATTERN.test(l),`The directory name "${l}" of the glob "${t}" is invalid.`]),[!PAGE_FILE_NAME_PATTERN.test(r)&&!PAGE_FILE_NAME_WITH_SQUARE_BRACKETS_PATTERN.test(r),`The file name "${r}" of the glob "${t}" is invalid.`]];return UPPERCASE_LETTER_PATTERN.test(o)&&consola.consola.info(`The glob "${o}" contains uppercase letters, it recommended to use lowercase letters.`),a.every(([l,p])=>(l&&consola.consola.warn(p),!l))}function transformPageGlobToRouterFile(o,t){const{cwd:e,pageDir:r,alias:n,routeNameTransformer:a}=t,l=getFullPathOfPageGlob(o,r,e);let p=i__default.posix.join(r,o);Object.entries(n).some(m=>{const[G,R]=m,A=p.startsWith(R);return A&&(p=p.replace(R,G)),A});const f=o.split(PATH_SPLITTER).reverse(),[P,...g]=f,d=g.filter(m=>!m.startsWith(PAGE_DEGREE_SPLITTER)).reverse(),E=a(d.join(PAGE_DEGREE_SPLITTER).toLocaleLowerCase());let _=transformRouterNameToPath(E),b="";if(PAGE_FILE_NAME_WITH_SQUARE_BRACKETS_PATTERN.test(P)){const[m]=P.split(".");b=m.replace(/\[|\]/g,""),_=`${_}/:${b}`}return{glob:o,fullPath:l,importPath:p,routeName:E,routePath:t.routePathTransformer(E,_),routeParamKey:b}}function transformRouterFilesToMaps(o,t){const e=new Map;return o.forEach(r=>{const{routeName:n,routePath:a}=r;splitRouterName(n).forEach(l=>{if(!e.has(l)){const p=l===n,f=p?l:t.routeNameTransformer(l),P=p?a:t.routePathTransformer(f,transformRouterNameToPath(l));e.set(f,P)}})}),e}function transformRouterMapsToEntries(o){const t=[];return o.forEach((e,r)=>{t.push([r,e])}),t.sort((e,r)=>e[0].localeCompare(r[0]))}function transformRouterEntriesToTrees(o,t){const e=new Map;o.forEach(([n])=>{if(!n.includes(PAGE_DEGREE_SPLITTER))e.set(n,[]);else{const a=n.split(PAGE_DEGREE_SPLITTER)[0],l=n.split(PAGE_DEGREE_SPLITTER).length,p=e.get(a)||[],f=p[l-2]||[];f.push(n),p[l-2]=f,e.set(a,p)}});const r=[];return e.forEach((n,a)=>{const l={routeName:a,routePath:t.get(a)||""},p=T(a,n,t);p.length>0&&(l.children=p),r.push(l)}),r}function T(o,t,e){if(t.length===0)return[];const[r,...n]=t;return r.filter(a=>a.startsWith(o)).map(a=>{const l={routeName:a,routePath:e.get(a)||""},p=T(a,n,e);return p.length>0&&(l.children=p),l})}function splitRouterName(o){return o.split(PAGE_DEGREE_SPLITTER).reduce((t,e)=>{const r=t[t.length-1],n=r?`${r}${PAGE_DEGREE_SPLITTER}${e}`:e;return t.push(n),t},[])}function transformRouterNameToPath(o){return PATH_SPLITTER+o.replaceAll(PAGE_DEGREE_SPLITTER,PATH_SPLITTER)}function log(o,t,e=!0){e&&consola.consola[t](`${kolorist.lightGreen("[elegant-router]")} ${o}`)}function setupWatcher(o,t,e,r=!0){const n=chokidar.watch(".",{ignoreInitial:!0,cwd:o,ignored:t}),a=[];function l(g){a.push(g)}function p(){a.length=0}let f=null;function P(g=500){f||(f=setTimeout(async()=>{await e(a),p(),f&&(clearTimeout(f),f=null)},g))}return n.on("ready",()=>{log("watcher ready","start",r)}),n.on("add",g=>{const d=normalizeWindowsPath(g);l(d),P()}),n.on("unlink",g=>{const d=normalizeWindowsPath(g);l(d),P()}),n}var h=Object.defineProperty,c=(o,t,e)=>t in o?h(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,s=(o,t,e)=>(c(o,typeof t!="symbol"?t+"":t,e),e);class F{constructor(t={}){s(this,"options"),s(this,"pageGlobs",[]),s(this,"files",[]),s(this,"maps",new Map),s(this,"entries",[]),s(this,"trees",[]),s(this,"fsWatcher"),this.options=createPluginOptions(t),this.scanPages()}scanPages(){this.getPageGlobs(),this.getRouterContextProps()}getPageGlobs(){const{pagePatterns:t,pageExcludePatterns:e,pageDir:r}=this.options,n=getGlobs(t,e,r);this.pageGlobs=this.filterValidPageGlobs(n)}filterValidPageGlobs(t,e=!1){const{cwd:r,pageDir:n}=this.options;return t.filter(a=>{const l=getFullPathOfPageGlob(a,n,r),p=handleValidatePageGlob(a,l),f=!e||this.isMatchPageGlob(a);return p&&f})}isMatchPageGlob(t){const{pagePatterns:e,pageExcludePatterns:r}=this.options;return u__default.isMatch(t,e,{ignore:r})}getRouterFileByGlob(t){return transformPageGlobToRouterFile(t,this.options)}getRouterContextProps(){this.files=this.pageGlobs.map(t=>transformPageGlobToRouterFile(t,this.options)),this.maps=transformRouterFilesToMaps(this.files,this.options),this.entries=transformRouterMapsToEntries(this.maps),this.trees=transformRouterEntriesToTrees(this.entries,this.maps)}setupFSWatcher(t,e){const{pageDir:r,pageExcludePatterns:n}=this.options;this.fsWatcher=setupWatcher(r,n,a=>{this.filterValidPageGlobs(a,!0).length>0&&(e?.(),this.scanPages(),t())},this.options.log)}stopFSWatcher(){this.fsWatcher?.close()}}exports.PAGE_DEGREE_SPLITTER=PAGE_DEGREE_SPLITTER,exports.PATH_SPLITTER=PATH_SPLITTER,exports.default=F,exports.splitRouterName=splitRouterName,exports.transformRouterNameToPath=transformRouterNameToPath;
